# 서버설정
# 서버의 메인 엔진 실행
FROM nginx:latest

ARG DOMAINS
ENV DOMAINS=${DOMAINS}

# 폴더가 없다면 생성
RUN mkdir -p /etc/nginx/sites-enabled /etc/nginx/sites-available

# 더미인증서를 넣을 폴더
RUN /bin/sh -c 'set -o noglob; echo "Setting up domains: $DOMAINS"; \
    for domain in $DOMAINS; do \
        mkdir -p /etc/letsencrypt/live/$domain; \
    done'

# 1일짜리 더미 인증서 생성
RUN /bin/sh -c 'set -o noglob; echo "Generating dummy certificates for domains: $DOMAINS"; \
    for domain in $DOMAINS; do \
        openssl req -x509 -nodes -newkey rsa:4096 -days 1 \
            -keyout /etc/letsencrypt/live/$domain/privkey.pem \
            -out /etc/letsencrypt/live/$domain/fullchain.pem \
            -subj "/CN=$domain"; \
    done'

CMD ["nginx", "-g", "daemon off;"]



#1. nginx  80, 433 포트생성
#2. 인증서 발급을 위한 433 default.conf 변경
#3. 인증서 발급 및 크론으로 재발급 등록
#4. 기존 도메인별로 작업한 것들을 compose volume을통해 이동시키고 nginx 재시동